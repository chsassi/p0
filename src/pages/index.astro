---
import HeaderLayout from "../layouts/HeaderLayout.astro";
import FooterLayout from "../layouts/FooterLayout.astro";
import artists from "../data/artists.json";
import releases from "../data/releases.json";
import news from "../data/news.json";
---

<HeaderLayout title="Protocol Zero" active="">
  <link rel="stylesheet" href="/styles/pages.css" />
  <link rel="stylesheet" href="/styles/artists.css" />
  <link rel="stylesheet" href="/styles/releases.css" />
  <link rel="stylesheet" href="/styles/index-scroll.css" />

  <!-- Page loader: black background + P0 logo with glow -->
  <div id="page-loader" class="page-loader" aria-hidden="true">
    <img src="/images/logo.svg" alt="Protocol Zero" class="loader-logo" />
  </div>

  <div class="main-scroll-container">
    <!-- Scroll Indicator Arrow -->
    <button class="scroll-indicator" aria-label="Scroll down">
      <img src="/images/icons/arrow_down.svg" alt="Scroll down" class="arrow-down nav-icon" />
      <img src="/images/icons/arrow_up.svg" alt="Scroll to top" class="arrow-up nav-icon" />
    </button>

    <!-- Hero Section - News Slideshow -->
    <section id="home" class="hero-section hero-slideshow">
      <div class="hero-slideshow-container">
        {news.map((item, i) => (
          <div class="hero-slide" data-slide={i}>
            {item.video ? (
              <div class="hero-slide-background">
                <video autoplay muted loop playsinline class="hero-video">
                  <source src={item.video} type="video/mp4" />
                </video>
              </div>
            ) : (
              <div class="hero-slide-background" style={`background-image: url(${item.image})`}></div>
            )}
            <div class="hero-slide-content">
              <div class="hero-logo-container">
                <img src="/images/logo.svg" alt="Protocol Zero Logo" class="hero-logo" />
              </div>
              <div class="hero-news-content">
                <span class="news-type-label">{item.title}</span>
                <h1 class="news-heading">{item.heading}</h1>
                <p class="news-description">{item.description}</p>
                <a href={item.link} class="news-link">{item.linkText}</a>
              </div>
              <nav class="hero-menu">
              </nav>
            </div>
          </div>
        ))}
      </div>
      <div class="hero-slideshow-indicators">
        {news.map((_, i) => (
          <button class="hero-indicator" data-slide={i} aria-label={`Go to news ${i + 1}`}></button>
        ))}
      </div>
      <button class="hero-nav-btn prev" aria-label="Previous news">
        <img src="../public/images/icons/arrow_left.svg" alt="Previous news" class="nav-icon" />
      </button>
      <button class="hero-nav-btn next" aria-label="Next news">
        <img src="/images/icons/arrow_right.svg" alt="Next news" class="nav-icon" />
      </button>
    </section>

    <script>
      // Type definition for slideshow config
      interface SlideshowConfig {
        containerSelector: string;
        slideSelector: string;
        indicatorSelector: string;
        nextBtnSelector: string;
        prevBtnSelector: string;
        autoplayInterval?: number;
        bgBlurSelector?: string | null;
      }

      // Reusable slideshow controller
      function createSlideshow(config: SlideshowConfig) {
        const {
          containerSelector,
          slideSelector,
          indicatorSelector,
          nextBtnSelector,
          prevBtnSelector,
          autoplayInterval = 5000,
          bgBlurSelector = null,
        } = config;

        let currentIndex = 0;
        const container = document.querySelector(containerSelector);
        const slides = Array.from(container?.querySelectorAll(slideSelector) || []);
        const indicators = Array.from(container?.querySelectorAll(indicatorSelector) || []);
        const nextBtn = container?.querySelector(nextBtnSelector);
        const prevBtn = container?.querySelector(prevBtnSelector);
        const bgBlur = bgBlurSelector ? document.querySelector(bgBlurSelector) : null;

        if (!slides.length) return;

        function updateSlide(index: number) {
          slides.forEach((slide: Element, i: number) => {
            slide.classList.toggle('active', i === index);
          });
          indicators.forEach((indicator: Element, i: number) => {
            indicator.classList.toggle('active', i === index);
          });

          // Update background blur if applicable
          if (bgBlur) {
            const bgImage = slides[index].getAttribute('data-image');
            if (bgImage) {
              (bgBlur as HTMLElement).style.backgroundImage = `url(${bgImage})`;
            }
          }

          currentIndex = index;
        }

        function next() {
          const nextIndex = (currentIndex + 1) % slides.length;
          updateSlide(nextIndex);
        }

        function prev() {
          const prevIndex = (currentIndex - 1 + slides.length) % slides.length;
          updateSlide(prevIndex);
        }

        // Event listeners
        nextBtn?.addEventListener('click', next);
        prevBtn?.addEventListener('click', prev);
        indicators.forEach((indicator: Element, i: number) => {
          indicator.addEventListener('click', () => updateSlide(i));
        });

        // Auto-play with pause on hover
        let autoplayTimer = setInterval(next, autoplayInterval);

        if (container) {
          container.addEventListener('mouseenter', () => clearInterval(autoplayTimer));
          container.addEventListener('mouseleave', () => {
            clearInterval(autoplayTimer);
            autoplayTimer = setInterval(next, autoplayInterval);
          });
        }

        // Initialize
        updateSlide(0);
      }

      // Initialize Hero slideshow
      createSlideshow({
        containerSelector: '.hero-slideshow',
        slideSelector: '.hero-slide',
        indicatorSelector: '.hero-slideshow-indicators .hero-indicator',
        nextBtnSelector: '.hero-nav-btn.next',
        prevBtnSelector: '.hero-nav-btn.prev',
        autoplayInterval: 6000,
      });

      // Initialize Artists slideshow
      createSlideshow({
        containerSelector: '.artists-slideshow',
        slideSelector: '.artist-slide',
        indicatorSelector: '.artists-slideshow-indicators .artist-indicator',
        nextBtnSelector: '.artist-slide-nav-btn.next',
        prevBtnSelector: '.artist-slide-nav-btn.prev',
        autoplayInterval: 5000,
        bgBlurSelector: '.artist-bg-blur',
      });

      // Initialize Releases slideshow
      createSlideshow({
        containerSelector: '.releases-slideshow',
        slideSelector: '.release-slide',
        indicatorSelector: '.slideshow-indicators .indicator',
        nextBtnSelector: '.slide-nav-btn.next',
        prevBtnSelector: '.slide-nav-btn.prev',
        autoplayInterval: 5000,
        bgBlurSelector: '.release-bg-blur',
      });

      // Scroll indicator functionality
      const scrollIndicator = document.querySelector('.scroll-indicator');

      function updateScrollIndicator() {
        const scrollPosition = window.scrollY;
        const windowHeight = window.innerHeight;
        const isScrolled = scrollPosition > windowHeight / 2;

        scrollIndicator?.classList.toggle('scrolled', isScrolled);
        scrollIndicator?.setAttribute('aria-label', isScrolled ? 'Scroll to top' : 'Scroll down');
      }

      scrollIndicator?.addEventListener('click', () => {
        const scrollPosition = window.scrollY;
        const windowHeight = window.innerHeight;

        if (scrollPosition > windowHeight / 2) {
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      });

      window.addEventListener('scroll', updateScrollIndicator, { passive: true });
      updateScrollIndicator();
    </script>

    <!-- About Section -->
    <section id="about" class="scroll-section about-section">
      <h1>ABOUT</h1>
      <div class="section-content">
        <p>Protocol Zero (P0) is an independent European drum & bass label founded between Slovakia and Italy by The Martens and Chr-s.</p>
        <p>Born from a shared vision of sound as both art and technology, the label focuses on the darker and more technical edges of drum & bass â€” from deep neurofunk to atmospheric techstep.</p>
        <p>P0 aims to connect European underground scenes through a unified aesthetic: precise sound design, immersive basslines, and a strong visual and conceptual identity.</p>
        <p>Born from a deep passion for dark and energetic drum & bass, the label stands for quality, precision and evolution in sound.</p>
      </div>
    </section>

    <!-- Artists Section -->
    <section id="artists" class="scroll-section artists-section artists-slideshow">
      <div class="artists-slideshow-container">
        {artists.map((artist, i) => (
          <div class="artist-slide" data-slide={i} data-image={artist.image}>
            <div class="artist-slide-layout">
              <div class="artist-slide-content">
                <div class="artist-slide-info">
                  <h2 class="artist-slide-title">{artist.name}</h2>
                  <a href={`/artists/${artist.slug}`} class="artist-slide-link">MORE INFO</a>
                </div>
              </div>
              <div class="artist-slide-image-container">
                <img src={artist.image} alt={artist.name} class="artist-slide-image" />
              </div>
            </div>
            <div class="artist-slide-navigation">
              <button class="artist-slide-nav-btn prev" aria-label="Previous artist">
                <img src="/images/icons/arrow_left.svg" alt="Previous artist" class="nav-icon" />
              </button>
              <button class="artist-slide-nav-btn next" aria-label="Next artist">
                <img src="/images/icons/arrow_right.svg" alt="Next artist" class="nav-icon" />
              </button>
            </div>
          </div>
        ))}
      </div>
      <div class="artists-slideshow-indicators">
        {artists.map((_, i) => (
          <button class="artist-indicator" data-slide={i} aria-label={`Go to artist ${i + 1}`}></button>
        ))}
      </div>
    </section>

    <!-- Releases Section -->
    <section id="releases" class="scroll-section releases-section releases-slideshow">
      <div class="slideshow-container">
        {releases.map((rel, i) => (
          <div class="release-slide" data-slide={i} data-image={rel.image}>
            <div class="slide-layout">
              <div class="slide-image-container">
                <img src={rel.image} alt={rel.title} class="slide-image" />
              </div>
              <div class="slide-content">
                <div class="slide-info">
                  <h2 class="slide-title">{rel.title}</h2>
                  <h3 class="slide-artist">{rel.artist}</h3>
                  <a href={`/releases/${rel.slug}`} class="slide-link">MORE INFO</a>
                  <div class="slide-date">{rel.date}</div>
                </div>
              </div>
            </div>
            <div class="slide-navigation">
              <button class="slide-nav-btn prev" aria-label="Previous slide">
                <img src="/images/icons/arrow_left.svg" alt="Previous slide" class="nav-icon" />
              </button>
              <button class="slide-nav-btn next" aria-label="Next slide">
                <img src="/images/icons/arrow_right.svg" alt="Next slide" class="nav-icon" />
              </button>
            </div>
          </div>
        ))}
      </div>
      <div class="slideshow-indicators">
        {releases.map((_, i) => (
          <button class="indicator" data-slide={i} aria-label={`Go to slide ${i + 1}`}></button>
        ))}
      </div>
    </section>

    <!-- Contacts Section -->
    <section id="contacts" class="scroll-section contacts-section">
      <h1>CONTACTS</h1>
      <div class="section-content">
        <p>For demo submissions or collaborations, feel free to reach out!</p>
        <p>Send us a private Soundcloud link at the following email:</p>
        <p><a href="mailto:demo@protocolzero.online">demo@protocolzero.online</a></p>
      </div>
    </section>
</HeaderLayout>
<FooterLayout />

<!-- Hide loader after full load / pageshow; only on first-time navigate (no fixed fallback timer) -->
<script>
  (function() {
    const loader = document.getElementById('page-loader');
    if (!loader) return;

    // If page is restored from bfcache, hide loader immediately
    window.addEventListener('pageshow', (e) => {
      if (e.persisted) {
        loader!.classList.add('loaded');
        setTimeout(() => { try { loader!.style.display = 'none'; } catch (e) {} }, 600);
      }
    });

    // Determine navigation type (navigate = first time)
    const navEntries = (performance.getEntriesByType && performance.getEntriesByType('navigation')) || [];
    const navType = navEntries[0] ? (navEntries[0] as PerformanceNavigationTiming).type : (performance.navigation && performance.navigation.type === 0 ? 'navigate' : 'navigate');

    if (navType === 'navigate') {
      // First-time navigation: keep loader until the page 'load' completes
      function hideLoader() {
        loader!.classList.add('loaded');
        setTimeout(() => { try { loader!.style.display = 'none'; } catch (e) {} }, 600);
        window.removeEventListener('load', hideLoader);
      }
      if (document.readyState === 'complete') {
        hideLoader();
      } else {
        window.addEventListener('load', hideLoader);
      }
    } else {
      // Back/forward or reload from cache: hide loader immediately
      loader!.classList.add('loaded');
      setTimeout(() => { try { loader!.style.display = 'none'; } catch (e) {} }, 600);
    }
  })();
</script>